<?php
/*****************************************************************************
*                                                        Â© 2013 Cart-Power   *
*           __   ______           __        ____                             *
*          / /  / ____/___ ______/ /_      / __ \____ _      _____  _____    *
*      __ / /  / /   / __ `/ ___/ __/_____/ /_/ / __ \ | /| / / _ \/ ___/    *
*     / // /  / /___/ /_/ / /  / /_/_____/ ____/ /_/ / |/ |/ /  __/ /        *
*    /_//_/   \____/\__,_/_/   \__/     /_/    \____/|__/|__/\___/_/         *
*                                                                            *
*                                                                            *
* -------------------------------------------------------------------------- *
* This is commercial software, only users who have purchased a valid license *
* and  accept to the terms of the License Agreement can install and use this *
* program.                                                                   *
* -------------------------------------------------------------------------- *
* website: https://store.cart-power.com                                      *
* email:   sales@cart-power.com                                              *
******************************************************************************/

namespace Tygh\Addons;defined('BOOTSTRAP') or die('Access denied'); use Tygh\Registry;use Tygh\Settings;use Tygh\Addons\SchemesManager;class CpAddonUpdater extends AXmlScheme{private $cpe_J2FkNG9uJ3LjaGVtNQ;private $cpe_J2xhbmdfI29kNQ;private $cpe_J2RiJ3LlI3Rpb24;private $cpe_J2RiJ3L1InLlI3Rpb25z;private $cpe_J2RiJ29wdGlvbnM;private $cpe_J2FkNG9uJ3LlI3Rpb25faWQ;private $cpe_J3LlI3Rpb25fdGFiJ2lk;private $cpe_J3LlI3Rpb25fc2V0dGluN19pNA;private $cpe_J3htbF90IWYz;public function __construct($cpe_IWRkb24){$this->cpe_J2xhbmdfI29kNQ = CART_LANGUAGE;SchemesManager::clearInternalCache($cpe_IWRkb24);$this->cpe_J2FkNG9uJ3LjaGVtNQ = SchemesManager::getScheme($cpe_IWRkb24);$this->cpe_J3htbF90IWYz = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getSections();}public function update($cpe_cGFyIW1z = array()){if (empty($this->cpe_J2FkNG9uJ3LjaGVtNQ->getId())) {return false;}if (empty($cpe_cGFyIW1z)) {$cpe_cGFyIW1z = array('settings' => true,'language_variables' => true,'queries'=> true,'addon_data' => true,'email_templates'=> true,'document_templates' => true,'snippet_templates'=> true);}$this->init_addon_db_data();if (!empty($cpe_cGFyIW1z['settings']) && !empty($this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ)) {$this->updateXMLTabs();$this->deleteObsoleteSections();}if (!empty($cpe_cGFyIW1z['language_variables'])) {$this->updateLanguageVariables();}if (version_compare($this->cpe_J2FkNG9uJ3LjaGVtNQ->getVersion(), $this->_current_version) <= 0) {return true;}if (!empty($cpe_cGFyIW1z['queries'])) {$this->updateQueries();}if (!empty($cpe_cGFyIW1z['email_templates'])) {$this->updateEmailTemplates();}if (!empty($cpe_cGFyIW1z['document_templates'])) {$this->updateDocumentTemplates();}if (!empty($cpe_cGFyIW1z['snippet_templates'])) {$this->updateSnippetTemplates();}if (!empty($cpe_cGFyIW1z['addon_data'])) {$this->updateAddonData();}return true;}private function init_addon_db_data(){$this->_current_version = db_get_field('SELECT version FROM ?:addons WHERE addon = ?s', $this->cpe_J2FkNG9uJ3LjaGVtNQ->getId());$this->cpe_J2RiJ3LlI3Rpb24 = Settings::instance()->getSectionByName($this->cpe_J2FkNG9uJ3LjaGVtNQ->getId(), Settings::ADDON_SECTION, false);if (empty($this->cpe_J2RiJ3LlI3Rpb24['section_id']) && !empty($this->cpe_J3htbF90IWYz)) {$cpe_dJBkIJRlJ3LlI3Rpb25fcGFyIW1ldGVycw = array('parent_id'=> 0,'edition_type' => $this->cpe_J2FkNG9uJ3LjaGVtNQ->getEditionType(),'name' => $this->cpe_J2FkNG9uJ3LjaGVtNQ->getId(),'type' => Settings::ADDON_SECTION,);$cpe_dJBkIJRlJ3LlI3Rpb25fcGFyIW1ldGVycw['section_id'] = Settings::instance()->updateSection($cpe_dJBkIJRlJ3LlI3Rpb25fcGFyIW1ldGVycw);if (empty($cpe_dJBkIJRlJ3LlI3Rpb25fcGFyIW1ldGVycw['section_id'])) {return false;} else {$this->cpe_J2RiJ3LlI3Rpb24 = $cpe_dJBkIJRlJ3LlI3Rpb25fcGFyIW1ldGVycw;}}if (!empty($this->cpe_J2RiJ3LlI3Rpb24['section_id'])) {$this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ = $this->cpe_J2RiJ3LlI3Rpb24['section_id'];$this->cpe_J2RiJ3L1InLlI3Rpb25z = Settings::instance()->getSectionTabs($this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ, $this->cpe_J2xhbmdfI29kNQ);$this->cpe_J2RiJ29wdGlvbnM = Settings::instance()->getList($this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ);}}private function updateXMLTabs(){if (empty($this->cpe_J3htbF90IWYz) || !is_array($this->cpe_J3htbF90IWYz)) {return;}foreach ($this->cpe_J3htbF90IWYz as $cpe_dGFiJ2luNGV4 => $tab) {$this->updateXMLTab($tab, $cpe_dGFiJ2luNGV4);}}private function updateXMLTab($tab, $cpe_dGFiJ2luNGV4){if (empty($this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ) || empty($tab['id'])) {return false;}$cpe_c2VjdGlvbl90IWYfaWQ = 0;$cpe_Nm91bmRfc3Vic2VjdGlvbg = array();if (!empty($this->cpe_J2RiJ3L1InLlI3Rpb25z)) {foreach ($this->cpe_J2RiJ3L1InLlI3Rpb25z as $cpe_dGFiJ2lk => $cpe_c3Vic2VjdGlvbg) {if ($tab['id'] == $cpe_dGFiJ2lk) {$cpe_c2VjdGlvbl90IWYfaWQ = $cpe_c3Vic2VjdGlvbg['section_id'];$cpe_Nm91bmRfc3Vic2VjdGlvbg = $cpe_c3Vic2VjdGlvbg;unset($this->cpe_J2RiJ3L1InLlI3Rpb25z[$cpe_dGFiJ2lk]);break;}}}$cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ = array('parent_id'=> $this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ,'edition_type' => $tab['edition_type'],'name' => $tab['id'],'position' => $cpe_dGFiJ2luNGV4 * 10,'type' => isset($tab['separate']) ? Settings::SEPARATE_TAB_SECTION : Settings::TAB_SECTION,);$cpe_c2tpcF9kIl9xdWVyeQ = false;if (!empty($cpe_c2VjdGlvbl90IWYfaWQ)) {$cpe_c2tpcF9kIl9xdWVyeQ = true;$cpe_aWdub3YlJ2NpNWxkcw = array('edition_type');foreach ($cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ as $cpe_NmllbGQ => $cpe_dmFsdWU) {if (in_array($cpe_NmllbGQ, $cpe_aWdub3YlJ2NpNWxkcw)) {continue;}if (!isset($cpe_Nm91bmRfc3Vic2VjdGlvbg[$cpe_NmllbGQ]) || $cpe_Nm91bmRfc3Vic2VjdGlvbg[$cpe_NmllbGQ] != $cpe_dmFsdWU) {$cpe_c2tpcF9kIl9xdWVyeQ = false;}}$cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ['section_id'] = $cpe_c2VjdGlvbl90IWYfaWQ;}if (!$cpe_c2tpcF9kIl9xdWVyeQ) {$cpe_NGYfaWQ = Settings::instance()->updateSection($cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ);}if (!empty($cpe_NGYfaWQ)) {if (empty($cpe_c2VjdGlvbl90IWYfaWQ)) {$cpe_c2VjdGlvbl90IWYfaWQ = $cpe_NGYfaWQ;}} elseif (!$cpe_c2tpcF9kIl9xdWVyeQ) {return false;}$this->cpe_J3LlI3Rpb25fdGFiJ2lk = $cpe_c2VjdGlvbl90IWYfaWQ;fn_update_addon_settings_descriptions($cpe_c2VjdGlvbl90IWYfaWQ, Settings::SECTION_DESCRIPTION, $tab['translations']);$this->updateXMLTabSettings($tab);return true;}private function updateXMLTabSettings($tab){ if (empty($this->cpe_J3LlI3Rpb25fdGFiJ2lk) || empty($tab['id'])) {return false;}$cpe_c2V0dGluN3M = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getSettings($tab['id']);if (!empty($cpe_c2V0dGluN3M)) {foreach ($cpe_c2V0dGluN3M as $cpe_cG9zaJRpb24 => $cpe_c2V0dGluNw) {$this->updateXMLTabSetting($tab, $cpe_c2V0dGluNw, $cpe_cG9zaJRpb24);}}}private function updateXMLTabSetting($tab, $cpe_c2V0dGluNw, $cpe_cG9zaJRpb24){if (empty($this->cpe_J3LlI3Rpb25fdGFiJ2lk) || empty($tab['id']) || empty($cpe_c2V0dGluNw['id'])) {return false;}$cpe_NJhpc3RlNF9zNJR0aW5n = array();$cpe_c2V0dGluN19pNA = 0;if (isset($this->cpe_J2RiJ29wdGlvbnM[$tab['id']])) {foreach ($this->cpe_J2RiJ29wdGlvbnM[$tab['id']] as $cpe_J3LldHRpbmdfaWQ => $cpe_J3LldHRpbmc) {if ($cpe_J3LldHRpbmc['name'] == $cpe_c2V0dGluNw['id']) {$cpe_NJhpc3RlNF9zNJR0aW5n = $cpe_J3LldHRpbmc;$cpe_c2V0dGluN19pNA = $cpe_J3LldHRpbmdfaWQ;unset($this->cpe_J2RiJ29wdGlvbnM[$tab['id']][$cpe_J3LldHRpbmdfaWQ]);break;}}}if (empty($cpe_c2V0dGluN19pNA)) {foreach ($this->cpe_J2RiJ29wdGlvbnM as $cpe_dGFiJ2lk => $cpe_dGFiJ3LldHRpbmdz) {if ($cpe_dGFiJ2lk == $tab['id']) {continue;}foreach ($cpe_dGFiJ3LldHRpbmdz as $cpe_J3LldHRpbmdfaWQ => $cpe_J3LldHRpbmc) {if ($cpe_J3LldHRpbmc['name'] == $cpe_c2V0dGluNw['id']) {$cpe_NJhpc3RlNF9zNJR0aW5n = $cpe_J3LldHRpbmc;$cpe_c2V0dGluN19pNA = $cpe_J3LldHRpbmdfaWQ;unset($this->cpe_J2RiJ29wdGlvbnM[$cpe_dGFiJ2lk][$cpe_J3LldHRpbmdfaWQ]);break;}}}}$cpe_c2tpcF9kIl9xdWVyeQ = false;$cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ = array('name' => $cpe_c2V0dGluNw['id'],'section_id' => $this->cpe_J2FkNG9uJ3LlI3Rpb25faWQ,'section_tab_id' => $this->cpe_J3LlI3Rpb25fdGFiJ2lk,'type' => $cpe_c2V0dGluNw['type'],'position' => isset($cpe_c2V0dGluNw['position']) ? $cpe_c2V0dGluNw['position'] : $cpe_cG9zaJRpb24 * 10,'edition_type' => $cpe_c2V0dGluNw['edition_type'],'is_global'=> 'N','handler'=> $cpe_c2V0dGluNw['handler'],);if (!empty($cpe_c2V0dGluN19pNA)) {$cpe_c2tpcF9kIl9xdWVyeQ = true;$cpe_aWdub3YlJ2NpNWxkcw = array();foreach ($cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ as $cpe_NmllbGQ => $cpe_dmFsdWU) {if (in_array($cpe_NmllbGQ, $cpe_aWdub3YlJ2NpNWxkcw)) {continue;}if (!isset($cpe_NJhpc3RlNF9zNJR0aW5n[$cpe_NmllbGQ]) || $cpe_NJhpc3RlNF9zNJR0aW5n[$cpe_NmllbGQ] != $cpe_dmFsdWU) {$cpe_c2tpcF9kIl9xdWVyeQ = false;}}$cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ['object_id'] = $cpe_c2V0dGluN19pNA;}if (!$cpe_c2tpcF9kIl9xdWVyeQ) {$cpe_NGYfaWQ = Settings::instance()->update($cpe_dJBkIJRlJ3LlI3Rpb25fNGF0IQ);}if (!empty($cpe_NGYfaWQ) && empty($cpe_c2V0dGluN19pNA)) {$cpe_c2V0dGluN19pNA = $cpe_NGYfaWQ;Settings::instance()->updateValueById($cpe_c2V0dGluN19pNA, $cpe_c2V0dGluNw['default_value']);} elseif (!empty($cpe_c2V0dGluN19pNA)&& (!empty($cpe_c2V0dGluNw['default_value']) && !empty($cpe_NJhpc3RlNF9zNJR0aW5n['variants'])&& isset($cpe_NJhpc3RlNF9zNJR0aW5n['value']) && !isset($cpe_NJhpc3RlNF9zNJR0aW5n['variants'][$cpe_NJhpc3RlNF9zNJR0aW5n['value']])|| !empty($cpe_NJhpc3RlNF9zNJR0aW5n['type']) && !empty($cpe_c2V0dGluNw['type']) && $cpe_NJhpc3RlNF9zNJR0aW5n['type'] != $cpe_c2V0dGluNw['type'])) {Settings::instance()->updateValueById($cpe_c2V0dGluN19pNA, $cpe_c2V0dGluNw['default_value']);} elseif (!$cpe_c2tpcF9kIl9xdWVyeQ) {return false;}$this->cpe_J3LlI3Rpb25fc2V0dGluN19pNA = $cpe_c2V0dGluN19pNA;fn_update_addon_settings_descriptions($cpe_c2V0dGluN19pNA, Settings::SETTING_DESCRIPTION, $cpe_c2V0dGluNw['translations']);$this->updateXMLTabSettingVariants($cpe_c2V0dGluNw, $cpe_NJhpc3RlNF9zNJR0aW5n);return true;}private function updateXMLTabSettingVariants($cpe_c2V0dGluNw){$cpe_NJhpc3RlNF92IJYpIW50cw = $this->getSettingVariants($cpe_c2V0dGluNw);if (!empty($cpe_c2V0dGluNw['variants'])) {foreach ($cpe_c2V0dGluNw['variants'] as $cpe_cG9zaJRpb24 => $cpe_dmFyaWFudA) {if (empty($cpe_dmFyaWFudA['id'])) {continue;}$cpe_dmFyaWFudF9pNA = 0;$cpe_NJhpc3RlNF92IJYpIW50 = array();if (!empty($cpe_NJhpc3RlNF92IJYpIW50cw)) {foreach ($cpe_NJhpc3RlNF92IJYpIW50cw as $key => $cpe_J3NhcmlhbnQ) {if ($cpe_J3NhcmlhbnQ['name'] == $cpe_dmFyaWFudF9pNA) {$cpe_dmFyaWFudF9pNA = $cpe_J3NhcmlhbnQ['variant_id'];$cpe_NJhpc3RlNF92IJYpIW50 = $cpe_J3NhcmlhbnQ;unset($cpe_NJhpc3RlNF92IJYpIW50cw[$key]);break;}}}$cpe_c2tpcF9kIl9xdWVyeQ = false;$cpe_dJBkIJRlJ3NhcmlhbnRfNGF0IQ = array('object_id'=> $this->cpe_J3LlI3Rpb25fc2V0dGluN19pNA,'name' => $cpe_dmFyaWFudA['id'],'position' => isset($cpe_dmFyaWFudA['position']) ? $cpe_dmFyaWFudA['position'] : $cpe_cG9zaJRpb24 * 10,);if (!empty($cpe_dmFyaWFudF9pNA)) {$cpe_c2tpcF9kIl9xdWVyeQ = true;$cpe_aWdub3YlJ2NpNWxkcw = array();foreach ($cpe_dJBkIJRlJ3NhcmlhbnRfNGF0IQ as $cpe_NmllbGQ => $cpe_dmFsdWU) {if (in_array($cpe_NmllbGQ, $cpe_aWdub3YlJ2NpNWxkcw)) {continue;}if (!isset($cpe_NJhpc3RlNF92IJYpIW50[$cpe_NmllbGQ]) || $cpe_NJhpc3RlNF92IJYpIW50[$cpe_NmllbGQ] != $cpe_dmFsdWU) {$cpe_c2tpcF9kIl9xdWVyeQ = false;}}$cpe_dJBkIJRlJ3NhcmlhbnRfNGF0IQ['variant_id'] = $cpe_dmFyaWFudF9pNA;}if (!$cpe_c2tpcF9kIl9xdWVyeQ) {$cpe_NGYfaWQ = Settings::instance()->updateVariant($cpe_dJBkIJRlJ3NhcmlhbnRfNGF0IQ);}if (!empty($cpe_NGYfaWQ)) {if (empty($cpe_dmFyaWFudF9pNA)) {$cpe_dmFyaWFudF9pNA = $cpe_NGYfaWQ;}} elseif (!$cpe_c2tpcF9kIl9xdWVyeQ) {return false;} if (!empty($cpe_dmFyaWFudF9pNA)) {fn_update_addon_settings_descriptions($cpe_dmFyaWFudF9pNA, Settings::VARIANT_DESCRIPTION, $cpe_dmFyaWFudA['translations']);}}}if (!empty($cpe_NJhpc3RlNF92IJYpIW50cw)) {foreach ($cpe_NJhpc3RlNF92IJYpIW50cw as $cpe_dmFyaWFudA) {$res = Settings::instance()->removeVariant($cpe_dmFyaWFudA['variant_id']);}}}private function getSettingVariants($cpe_c2V0dGluNw){if (empty($cpe_c2V0dGluNw['id'])) {return array();}$cpe_b2YqNWL0J2lk = Settings::instance()->getId($cpe_c2V0dGluNw['id'], $this->cpe_J2FkNG9uJ3LjaGVtNQ->getId());if (empty($cpe_b2YqNWL0J2lk)) {return array();}$cpe_b2YqNWL0J2LvbmRpdGlvbg = db_quote('?:settings_variants.object_id = ?i AND', $cpe_b2YqNWL0J2lk);$cpe_dmFyaWFudHM = db_get_array('SELECT ?:settings_variants.*, ?:settings_descriptions.value, ?:settings_descriptions.object_type FROM ?:settings_variants'. ' INNER JOIN ?:settings_descriptions ON ?:settings_descriptions.object_id = ?:settings_variants.variant_id AND object_type = ?s'. ' WHERE ?p ?:settings_descriptions.lang_code = ?s ORDER BY ?:settings_variants.position',Settings::VARIANT_DESCRIPTION, $cpe_b2YqNWL0J2LvbmRpdGlvbg, $this->cpe_J2xhbmdfI29kNQ);return $cpe_dmFyaWFudHM;}private function deleteObsoleteSections(){if (!empty($this->cpe_J2RiJ3L1InLlI3Rpb25z)) {foreach ($this->cpe_J2RiJ3L1InLlI3Rpb25z as $cpe_dGFiJ2lk => $cpe_c3Vic2VjdGlvbg) {$res = Settings::instance()->removeSection($cpe_c3Vic2VjdGlvbg['section_id']);}}if (!empty($this->cpe_J2RiJ29wdGlvbnM)) {foreach ($this->cpe_J2RiJ29wdGlvbnM as $cpe_dGFiJ2lk => $cpe_c2V0dGluN3M) {foreach ($cpe_c2V0dGluN3M as $cpe_J3LldHRpbmdfaWQ => $cpe_J3LldHRpbmc) {$res = Settings::instance()->removeById($cpe_J3LldHRpbmc['object_id']);}}}}private function updateQueries(){$cpe_NWRpdGlvbg = PRODUCT_EDITION;$cpe_cJVlcmllcw = $this->cpe_J2FkNG9uJ3LjaGVtNQ->_xml->xpath("//queries/*[(@for='install' or not(@for)) and (contains(@editions, '{$cpe_NWRpdGlvbg}') or not(@editions))]");if ($cpe_cJVlcmllcw) {$cpe_cJVlcmllcw = $this->filterByVersion($cpe_cJVlcmllcw);foreach ($cpe_cJVlcmllcw as $cpe_cJVlcnk) {$cpe_IJR0cmlidJRlcw = $cpe_cJVlcnk->attributes();$cpe_NGYRdWVyeQ = (string)$cpe_cJVlcnk;if (isset($cpe_IJR0cmlidJRlcw['type']) && (string) $cpe_IJR0cmlidJRlcw['type'] == 'file') {if(file_exists($this->_addon_path . '/' . $cpe_NGYRdWVyeQ)) {db_import_sql_file($this->_addon_path . '/' . $cpe_NGYRdWVyeQ, 16384, false);}}else {db_query($cpe_NGYRdWVyeQ);}}}}private function filterByVersion($cpe_aJRlbJM){if (empty($cpe_aJRlbJM)) {return array();}$cpe_I3VycmVudA = $this->_current_version;$cpe_I29uc2lkNJYlNA = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getVersion();$cpe_aJRlbJM = array_filter($cpe_aJRlbJM, function($cpe_aJRlbQ) use ($cpe_I3VycmVudA, $cpe_I29uc2lkNJYlNA) {return !empty($cpe_aJRlbQ['version']) && version_compare($cpe_aJRlbQ['version'], $cpe_I3VycmVudA) > 0 && version_compare($cpe_aJRlbQ['version'], $cpe_I29uc2lkNJYlNA) <= 0;});cp_stable_uasort($cpe_aJRlbJM, function($a, $b) {return version_compare($a['version'], $b['version']);});return $cpe_aJRlbJM;}private function updateAddonData(){$cpe_J2RhdGE = array('addon' => $this->cpe_J2FkNG9uJ3LjaGVtNQ->getId(),'priority' =>$this->cpe_J2FkNG9uJ3LjaGVtNQ->getPriority(),'version' => $this->cpe_J2FkNG9uJ3LjaGVtNQ->getVersion(),'has_icon' => $this->cpe_J2FkNG9uJ3LjaGVtNQ->hasIcon());db_query('UPDATE ?:addons SET ?u WHERE addon = ?s', $cpe_J2RhdGE, $this->cpe_J2FkNG9uJ3LjaGVtNQ->getId());foreach ($this->cpe_J2FkNG9uJ3LjaGVtNQ->getAddonTranslations() as $cpe_dHYhbnLsIJRpb24) {db_query('REPLACE INTO ?:addon_descriptions ?e', array('lang_code' => $cpe_dHYhbnLsIJRpb24['lang_code'],'addon' =>$this->cpe_J2FkNG9uJ3LjaGVtNQ->getId(),'name' => $cpe_dHYhbnLsIJRpb24['value'],'description' => isset($cpe_dHYhbnLsIJRpb24['description']) ? $cpe_dHYhbnLsIJRpb24['description'] : ''));}}private function updateEmailTemplates(){if (!method_exists('addon_scheme', 'getEmailTemplates')) {return;}$cpe_NW1haWxfdGVtcGxhdGVz = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getEmailTemplates();if (!empty($cpe_NW1haWxfdGVtcGxhdGVz)) {if (!empty($cpe_NW1haWxfdGVtcGxhdGVz['templates'])) {$cpe_NW1haWxfdGVtcGxhdGVz['templates'] = $this->filterByVersion($cpe_NW1haWxfdGVtcGxhdGVz['templates']);}if (!empty($cpe_NW1haWxfdGVtcGxhdGVz['snippets'])) {$cpe_NW1haWxfdGVtcGxhdGVz['snippets'] = $this->filterByVersion($cpe_NW1haWxfdGVtcGxhdGVz['snippets']);}$cpe_NW1haWxfNJhpbQ = \Tygh::$app['template.mail.exim'];if (!empty($cpe_NW1haWxfNJhpbQ) && (!empty($cpe_NW1haWxfdGVtcGxhdGVz['templates']) || !empty($cpe_NW1haWxfdGVtcGxhdGVz['snippets']))) {$cpe_NW1haWxfNJhpbQ->import($cpe_NW1haWxfdGVtcGxhdGVz);}}}private function updateDocumentTemplates(){if (!method_exists('addon_scheme', 'getDocumentTemplates')) {return;}$cpe_NG9jdW1lbnRfdGVtcGxhdGVz = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getDocumentTemplates();if (!empty($cpe_NG9jdW1lbnRfdGVtcGxhdGVz)) {$cpe_NG9jdW1lbnRfdGVtcGxhdGVz = $this->filterByVersion($cpe_NG9jdW1lbnRfdGVtcGxhdGVz);$cpe_NG9jdW1lbnRfNJhpbQ = \Tygh::$app['template.document.exim'];if (!empty($cpe_NG9jdW1lbnRfNJhpbQ) && !empty($cpe_NG9jdW1lbnRfdGVtcGxhdGVz)) {$cpe_NG9jdW1lbnRfNJhpbQ->import($cpe_NG9jdW1lbnRfdGVtcGxhdGVz);}}}private function updateSnippetTemplates(){if (!method_exists('addon_scheme', 'getSnippetTemplates')) {return;}$cpe_c25pcHBldF90NW1wbGF0NJM = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getSnippetTemplates();if (!empty($cpe_c25pcHBldF90NW1wbGF0NJM)) {$cpe_c25pcHBldF90NW1wbGF0NJM = $this->filterByVersion($cpe_c25pcHBldF90NW1wbGF0NJM);$cpe_c25pcHBldF9leGlt = \Tygh::$app['template.snippet.exim'];if (!empty($cpe_c25pcHBldF9leGlt) && !empty($cpe_c25pcHBldF90NW1wbGF0NJM)) {$cpe_c25pcHBldF9leGlt->import($cpe_c25pcHBldF90NW1wbGF0NJM);}}}private function updateLanguageVariables(){$cpe_bGFuN3VhN2VfcGFjaw = array();$cpe_NGVmIJVsdF9sIW5n = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getDefaultLanguage();$cpe_dHYhbmxhdGlvbl9sIW5ndWFnNJM = fn_get_translation_languages();if (class_exists('Tygh\Addons\XmlScheme3')) {$cpe_bGFuN3VhN2VfdmFyaWFibGVz = $this->cpe_J2FkNG9uJ3LjaGVtNQ->getLanguageValues(false);foreach ($cpe_bGFuN3VhN2VfdmFyaWFibGVz as $cpe_bGFuN192IJZ) {$cpe_bGFuN3VhN2VfcGFjaw[$cpe_bGFuN192IJZ['name']][$cpe_bGFuN192IJZ['lang_code']] = $cpe_bGFuN192IJZ['value'];}} else {$cpe_bm9kNQ = '//language_variables';$cpe_bGFuN3VhN2VfcGFjaw = array();foreach ($cpe_dHYhbmxhdGlvbl9sIW5ndWFnNJM as $cpe_bGFuN19jb2Rl => $_v) {if (!empty($this->cpe_J2FkNG9uJ3LjaGVtNQ->_xml)) {$cpe_I3VycmVudF9sIW5ndmFycw = $this->cpe_J2FkNG9uJ3LjaGVtNQ->_xml->xpath($cpe_bm9kNQ . "/item[@lang='$cpe_bGFuN19jb2Rl']");} else {break;}foreach ($cpe_I3VycmVudF9sIW5ndmFycw as $cpe_bGFuN192IJZ) {$id = (string) $cpe_bGFuN192IJZ['id'];if (!isset($cpe_bGFuN3VhN2VfcGFjaw[$id])) {$cpe_bGFuN3VhN2VfcGFjaw[$id] = array();}$cpe_bGFuN3VhN2VfcGFjaw[$id][$cpe_bGFuN19jb2Rl] = (string) $cpe_bGFuN192IJZ;}}}if (empty($cpe_bGFuN3VhN2VfcGFjaw)) {return;}$cpe_bGFuN3M = array();foreach ($cpe_bGFuN3VhN2VfcGFjaw as $id => $cpe_bGFuN19kIJRh) {if (!is_array($cpe_bGFuN19kIJRh) || empty($cpe_bGFuN19kIJRh)) {continue;}if (isset($cpe_bGFuN19kIJRh[$cpe_NGVmIJVsdF9sIW5n])) {$cpe_NGVmIJVsdF92IWx1NQ = $cpe_bGFuN19kIJRh[$cpe_NGVmIJVsdF9sIW5n];} else {$cpe_NGVmIJVsdF92IWx1NQ = $cpe_bGFuN19kIJRh[key($cpe_bGFuN19kIJRh)];}foreach ($cpe_dHYhbmxhdGlvbl9sIW5ndWFnNJM as $cpe_bGFuN19jb2Rl => $_v) {if (!isset($cpe_bGFuN19kIJRh[$cpe_bGFuN19jb2Rl])) {$cpe_bGFuN19kIJRh[$cpe_bGFuN19jb2Rl] = $cpe_NGVmIJVsdF92IWx1NQ;}}ksort($cpe_bGFuN19kIJRh);foreach ($cpe_bGFuN19kIJRh as $cpe_bGFuN19jb2Rl => $cpe_bGFuN192IJZ) {$cpe_bGFuN3M[] = array('lang_code' => $cpe_bGFuN19jb2Rl,'name' => $id,'value' => $cpe_bGFuN192IJZ,);}}if (!empty($cpe_bGFuN3M)) {db_query('REPLACE INTO ?:language_values ?m', $cpe_bGFuN3M);}}public function getAddonName(){return $this->cpe_J2FkNG9uJ3LjaGVtNQ->getName();}protected function _getLangVarsSectionName() {}public function getSections() {}public function getSettings($cpe_c2VjdGlvbl9pNA) {}protected function getQueries($cpe_bW9kNQ = '') {}public function getDefaultLanguage() {}}function cp_stable_uasort(&$cpe_IJYyIJk, $cpe_I21wJ2N1bmL0aW9u) { if(count($cpe_IJYyIJk) < 2) { return; } $cpe_aGFsNndheQ = count($cpe_IJYyIJk) / 2; $cpe_IJYyIJkx = array_slice($cpe_IJYyIJk, 0, $cpe_aGFsNndheQ, true); $cpe_IJYyIJky = array_slice($cpe_IJYyIJk, $cpe_aGFsNndheQ, null, true); cp_stable_uasort($cpe_IJYyIJkx, $cpe_I21wJ2N1bmL0aW9u); cp_stable_uasort($cpe_IJYyIJky, $cpe_I21wJ2N1bmL0aW9u); if(call_user_func($cpe_I21wJ2N1bmL0aW9u, end($cpe_IJYyIJkx), reset($cpe_IJYyIJky)) < 1) { $cpe_IJYyIJk = $cpe_IJYyIJkx + $cpe_IJYyIJky; return; } $cpe_IJYyIJk = array(); reset($cpe_IJYyIJkx); reset($cpe_IJYyIJky); while(current($cpe_IJYyIJkx) && current($cpe_IJYyIJky)) { if(call_user_func($cpe_I21wJ2N1bmL0aW9u, current($cpe_IJYyIJkx), current($cpe_IJYyIJky)) < 1) { $cpe_IJYyIJk[key($cpe_IJYyIJkx)] = current($cpe_IJYyIJkx); next($cpe_IJYyIJkx); } else { $cpe_IJYyIJk[key($cpe_IJYyIJky)] = current($cpe_IJYyIJky); next($cpe_IJYyIJky); }} while(current($cpe_IJYyIJkx)) { $cpe_IJYyIJk[key($cpe_IJYyIJkx)] = current($cpe_IJYyIJkx); next($cpe_IJYyIJkx); } while(current($cpe_IJYyIJky)) { $cpe_IJYyIJk[key($cpe_IJYyIJky)] = current($cpe_IJYyIJky); next($cpe_IJYyIJky);} return;}